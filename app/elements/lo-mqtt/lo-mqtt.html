<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="//cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
<script src="../../scripts/stomp.js"></script>

<dom-module id="lo-mqtt">

  <script>
  (function() {
    'use strict';


    var me;
    var client;
    var topic;
    var deviceid;
    var that;

    function connectthis(){
      var ws = new SockJS('http://opantwerpen.be:15674/stomp');
      client = Stomp.over(ws);

      // SockJS does not support heart-beat: disable heart-beats
      client.heartbeat.outgoing = 0;
      client.heartbeat.incoming = 0;

      client.connect('guest', 'guest', me.onConnect, me.onError, '/');   

    }

    Polymer({
      is: 'lo-mqtt',

      properties: {
        autoConnect: {
          type: Boolean,
          value: false
        },
        connected: {
          type: Boolean,
          value: false,
          notify: true,
          observer: '_connected'
        },
        topic: {
          type: String,
          observer: '_topic'
        },
        deviceid: {
          type: String,
          observer: '_deviceid'
        }
      },

      attached: function(){
        that = this;
        me = document.querySelector('#mqtt');
        
      },

      connect: function(){
        connectthis();
      },

      _connected: function(){
        if(this.connected){
          console.log("MQTT: Event _connected changed");
          this.subscribe(this.deviceid);
        }
      },

      _topic: function(){
        topic = this.topic;
      },

      _deviceid: function(){
        console.log("MQTT: Device id has arrived");
        deviceid = this.deviceid;
        if(this.autoConnect){
          connectthis();
        }
        this.subscribe(deviceid);
      },

      onConnect: function(){
        console.log('Connected');
        me.connected = true;
        //me.subscribe(topic);
        me.subscribe(that.deviceid);
      },

      onError: function(){
        console.log('Error / Disconnect');
        me.connected = false;
      },

      subscribe: function(topic){
        console.log('Im subscribing to ', topic);
        client.subscribe(topic, function(d) {
          
          //me.send(topic, "ahlo");
          var msg = d.body.split('|');
          that.fireevent(msg);
          //console.log(msg);
        });
      },

      send: function(topic, data){
        console.log('sending msg to ', topic, 'data: ', data);
        client.send(topic, {'content-type':'text/plain'}, data);
      },

      fireevent: function(e){
        //console.log("TEsting!", e);
        that.fire('message-received', {msg: e});
      }


    });
  })();
  </script>
</dom-module>
