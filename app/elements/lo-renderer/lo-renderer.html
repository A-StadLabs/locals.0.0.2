<!-- Copyright (c) 2015 The Locals Project Authors. All rights reserved.
See authors.md for a list of all members.
 -->
 
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../lo-peers/lo-peers.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">

<dom-module id="lo-renderer">
  <style>
    :host {
      display: block;
      width: 300px;
      height: 440px; 
      overflow: hidden;
    }

    #rendercanvas {
      height: 360px;
      margin: 0px 0px 0px 2px;
    }

/*    #rendercanvas:active {
      margin: 2px 0px 0px 0px;
    }*/

    lo-peers {
      box-shadow: 0px 0px 5px rgba(0,0,0,0.1);
    }


    .renderbtns {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      padding: 0px;
      margin: 0px;
    }

    .renderbtns button {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      border: none;
      outline: 0;
      background-color: rgba(0,0,0,0);
      border-radius: 0px;
      padding: 2px;
      margin: 0px 1px 0px 1px;
    }



    p {
      color: black;
      font-family: OpensansLight;
      font-size: 16px;
      margin: 0px 0px 0px 2px;
      padding: 0px;
    }

    .confirmbtns {
      background-color: white;
      height: 60px;
      width: 90%;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
    }

    .confirmbtns button {
      width: 50%;
      margin: 0px 1px 0px 1px;


      height: 50px;
      border-radius: 5px;
      background-color: transparent;
      border: 1px solid rgba(0,0,0,0.1);
      outline: 0;
      padding: 0px 15px 0px 15px;


    }
    .valuesbar {
      width: 100%;
      padding: 15px;
      height: 90px;
      background-color: yellow;
      @apply(--layout-horizontal);
      @apply(--layout-center);
      box-sizing:border-box;
      }



</style>
<template> 
  <neon-animated-pages selected="{{selected}}" entry-animation="{{entryAnimation}}" exit-animation="{{exitAnimation}}">
    <neon-animatable>

      <div id="rendercanvas" on-tap="activate">
      </div>
      
      <template is="dom-if" if="{{activ}}">
        <div class="renderbtns layout horizontal">
          
<!--           <button on-tap="open">
            <img src="visualbtn.svg">
          </button>
 -->
      <template is="dom-if" if="{{!opened}}">
          <button on-tap="toValues" class="values">
            <img src="../../images/values.svg">
          </button>

          <button on-tap="toPeerlist">
            <img src="../../images/accept-green.svg">
            <p><span>{{objectpeers.length}}</span></p>
          </button>
      </template>

        </div>
      </template>



      <template is="dom-if" if="{{opened}}">
      <template is="dom-if" if="{{locked}}">
        
        <div>
          <button class="unlockbtn" on-tap="unlock">unlock</button>
          <span class="flex"></span>

          <button class="peerslistbtn" on-tap="toPeerlist">
            <img src="../../images/accept-green.svg">
            <p><span>{{peers.length}}</span></p>
          </button>
        </div>

      </template>
      </template>



      <template is="dom-if" if="{{opened}}">
      <template is="dom-if" if="{{!locked}}">

        <div class="confirmbtns">
          <button on-tap="cancel">
            <img src="../../images/decline.svg">
          </button>
          <button on-tap="confirm">
            <img src="../../images/accept.svg">
          </button>
        </div>

      </template>
      </template>


    </neon-animatable>
    <neon-animatable>
      <lo-peers peers="{{objectpeers}}"></lo-peers>
    </neon-animatable>

  </neon-animated-pages>


</template>
</dom-module>
<script>
(function() {

  var elem; 

  Polymer({
    is: 'lo-renderer',

    behaviors: [
      Polymer.NeonAnimationRunnerBehavior
    ],


    properties: {
      objectname: {
        type: String
      },

      objectconfig: {
        type: Object,
        notify: true,
        //observer: "_config"
      },

      objectdata: {
        type: Object,
        observer: "_dataset",
        notify: true
      },

      objectcomponent: {
        type: String
      },

      hash: {
        type: String
      },

      activ: {
        type: Boolean,
        value: false,
        notify: true
      },

      opened: {
        type: Boolean,
        value: false
      }

    },

    listeners: {
      // this event is fired when the animation finishes
      // 'neon-animation-finish': '_onNeonAnimationFinish'
    },

    attached: function() {
      this.async(function() {
      //console.log(this.localName + '#' + this.id + ' was attached');
      //this.selected = 1;
      });
    },

    ready: function(){
      this.selected = 0;

      this.oldconfig = this.objectconfig;
      this.newconfig = this.objectconfig;

      this.entryAnimation = 'slide-from-right-animation';
      this.exitAnimation = 'slide-left-animation';

      this.addEventListener('new-peer', function(){
        this.validate();
      });

    },

    _dataset: function(){      
      this.importHref("../elements/labs002-components/"+this.objectcomponent+".html", function(e) {
        var rendercanvas = this.$.rendercanvas;
        rendercanvas.innerHTML = '';
        elem = document.createElement(this.objectcomponent);
        elem.objectconfig = this.newconfig;
        elem.objectdata = this.objectdata;
        elem.objectname = this.objectname;
        elem.peers = this.objectpeers;
        elem.objecthash = this.hash;
        elem.id = this.objectname;
        rendercanvas.appendChild(elem);
      }, function(e) {
         //console.log('import',e);
        // loading error
      });
    },

    _data: function(){
      // Maak eerst het render plaatske leeg
      //console.log('data changed', this.objectdata);
    },

    _config: function(){
      // Maak eerst het render plaatske leeg
      //console.log('config changed', this.objectconfig);
      this.newconfig = this.objectconfig;
    },

    //_dataset: function(){
    attached: function(){
      // Maak eerst het render plaatske leeg
      //console.log('data changed', this.objectdata);
      // De gepaste webcomponent inladen  
    },

    toValues: function(){
      var object = document.getElementById(this.objectname);
      object.selected = 2;
      this.opened = true;
      // this.selected = 1;
    },


    toPeerlist: function(){
      this.selected = 1;
    },

    toObject: function(){
      this.selected = 0;
    },

    validate: function(){
      //console.log("ask for validation");
      this.fire('add-getuige', { objectname: this.objectname, objectconfig: JSON.stringify(this.objectconfig), objectdata: JSON.stringify(this.objectdata), userid: this.publickey, hash: this.hash });
    },

    activate: function(){
      if(!this.opened){
      this.activ =! this.activ;
      console.log(this.activ);
      };
    },

    open: function(){
      var object = document.getElementById(this.objectname);
      object.opened = true;
      this.opened = true;
      this.activ = false;
    },

    cancel: function(){
      var object = document.getElementById(this.objectname);
      object.objectconfig = this.oldconfig;
      object.opened = false;
      this.opened = false;
      this.activ = true;
      this._dataset();
    },

    confirm: function(){
      var object = document.getElementById(this.objectname);

        this.fire('save-it', { datasetkey: this.objectname, dataset: this.objectdata, hash: this.objecthash, config: this.newconfig });

        // Hier moet nog een check komen; als de hash van de nieuwe set data niet dezelfde is als de vorige hash moeten alle peers gedelete worden.

      object.opened = false;
      this.opened = false;
      this.activ = true;
<<<<<<< HEAD

    },

    unlock: function(){
      this.locked = false;
      var object = document.getElementById(this.objectname);
      object.locked = false;
=======
>>>>>>> origin/master
    }


  });
})();
</script>
